generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id           Int      @id @default(autoincrement())
  fullName     String   @map("full_name")
  email        String   @unique
  phone        String?
  passwordHash String   @map("password_hash")
  userType     UserType @map("user_type")
  isVerified   Boolean  @default(false) @map("is_verified")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sessions      Session[]
  products      Product[]      @relation("UserProducts")
  orders        Order[]        @relation("CustomerOrders")
  sellerItems   OrderItem[]    @relation("SellerOrderItems")
  notifications Notification[]
  reviews       Review[]

  @@index([email])
  @@index([userType])
  @@map("users")
}

// Session model
model Session {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// NEW: Product model
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(12, 2)
  stock       Int      @default(0)
  categoryId  Int      @map("category_id")
  sellerId    Int      @map("seller_id")
  images      String[]
  rating      Decimal  @default(0) @db.Decimal(3, 2) // ratingAvg
  ratingCount Int      @default(0) @map("rating_count")
  soldCount   Int      @default(0) @map("sold_count")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category   Category    @relation(fields: [categoryId], references: [id])
  seller     User        @relation("UserProducts", fields: [sellerId], references: [id])
  orderItems OrderItem[]
  reviews    Review[]

  @@map("products")
}

model Review {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  userId    Int      @map("user_id")
  orderId   Int      @map("order_id") // để khóa “đã mua”
  rating    Int // 1..5
  comment   String?  @db.Text
  images    String[] // optional
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, productId, userId]) // 1 user review 1 product trong 1 order
  @@index([productId])
  @@index([userId])
  @@index([orderId])
  @@map("reviews")
}

// NEW: Category model
model Category {
  id          Int      @id @default(autoincrement())
  name        String
  icon        String?
  color       String?
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  products Product[]

  @@map("categories")
}

model Order {
  id            Int           @id @default(autoincrement())
  orderNumber   String        @unique @map("order_number")
  customerId    Int           @map("customer_id")
  totalAmount   Decimal       @map("total_amount") @db.Decimal(12, 2)
  shippingFee   Decimal       @default(0) @map("shipping_fee") @db.Decimal(10, 2)
  status        OrderStatus   @default(pending)
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(unpaid) @map("payment_status")

  // Shipping info
  shippingName    String @map("shipping_name")
  shippingPhone   String @map("shipping_phone")
  shippingAddress String @map("shipping_address") @db.Text

  note String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  customer User        @relation("CustomerOrders", fields: [customerId], references: [id])
  items    OrderItem[]
  reviews  Review[]

  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

// Order Item model
model OrderItem {
  id          Int     @id @default(autoincrement())
  orderId     Int     @map("order_id")
  productId   Int     @map("product_id")
  sellerId    Int     @map("seller_id")
  productName String  @map("product_name")
  price       Decimal @db.Decimal(12, 2)
  quantity    Int
  subtotal    Decimal @db.Decimal(12, 2)
  image       String?

  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  seller  User    @relation("SellerOrderItems", fields: [sellerId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([sellerId])
  @@map("order_items")
}

// Enum for user types
enum UserType {
  customer
  seller
}

// Enums
enum OrderStatus {
  pending // Chờ xác nhận
  confirmed // Đã xác nhận
  preparing // Đang chuẩn bị
  shipping // Đang giao
  delivered // Đã giao
  cancelled // Đã hủy
  returned // Đã trả hàng
}

enum PaymentMethod {
  cod // Thanh toán khi nhận hàng
  bank_transfer // Chuyển khoản
  momo // Ví MoMo
  zalopay // ZaloPay
  credit_card // Thẻ tín dụng
}

enum PaymentStatus {
  unpaid // Chưa thanh toán
  paid // Đã thanh toán
  refunded // Đã hoàn tiền
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String // order | system | promotion | review | message
  title     String
  message   String
  actionUrl String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}
