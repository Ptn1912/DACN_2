generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int                @id @default(autoincrement())
  fullName          String             @map("full_name")
  email             String             @unique
  phone             String?
  passwordHash      String             @map("password_hash")
  userType          UserType           @map("user_type")
  avatar            String?            @map("avatar")  
  isVerified        Boolean            @default(false) @map("is_verified")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  
  sellerItems       OrderItem[]        @relation("SellerOrderItems")
  orders            Order[]            @relation("CustomerOrders")
  products          Product[]          @relation("UserProducts")
  sessions          Session[]
  notifications Notification[]
  spaylaterCustomer SPayLaterCustomer?
  reviews       Review[]
  
  conversationsAsUser1 Conversation[] @relation("ConversationUser1")
  conversationsAsUser2 Conversation[] @relation("ConversationUser2")
  sentMessages         Message[]      @relation("MessageSender")
  receivedMessages     Message[]      @relation("MessageReceiver")

  @@index([email])
  @@index([userType])
  @@map("users")
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

model Product {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  price       Decimal     @db.Decimal(12, 2)
  stock       Int         @default(0)
  categoryId  Int         @map("category_id")
  sellerId    Int         @map("seller_id")
  images      String[]
  rating      Decimal?    @default(0) @db.Decimal(3, 2)
  ratingCount Int      @default(0) @map("rating_count")
  soldCount   Int         @default(0) @map("sold_count")
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  orderItems  OrderItem[]
  reviews    Review[]
  category    Category    @relation(fields: [categoryId], references: [id])
  seller      User        @relation("UserProducts", fields: [sellerId], references: [id])
  
  // New chat relation
  messages    Message[]

  @@index([categoryId])
  @@index([sellerId])
  @@index([isActive])
  @@map("products")
}

model Review {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  userId    Int      @map("user_id")
  orderId   Int      @map("order_id") // để khóa “đã mua”
  rating    Int // 1..5
  comment   String?  @db.Text
  images    String[] // optional
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, productId, userId]) // 1 user review 1 product trong 1 order
  @@index([productId])
  @@index([userId])
  @@index([orderId])
  @@map("reviews")
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String
  icon        String?
  color       String?
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  products    Product[]

  @@map("categories")
}

model Order {
  id                    Int                    @id @default(autoincrement())
  orderNumber           String                 @unique @map("order_number")
  customerId            Int                    @map("customer_id")
  totalAmount           Decimal                @map("total_amount") @db.Decimal(12, 2)
  shippingFee           Decimal                @default(0) @map("shipping_fee") @db.Decimal(10, 2)
  status                OrderStatus            @default(pending)
  paymentMethod         PaymentMethod          @map("payment_method")
  paymentStatus         PaymentStatus          @default(PENDING) @map("payment_status")
  shippingName          String                 @map("shipping_name")
  shippingPhone         String                 @map("shipping_phone")
  shippingAddress       String                 @map("shipping_address")
  note                  String?
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  
  // Existing relations
  items                 OrderItem[]
  reviews  Review[]
  customer              User                   @relation("CustomerOrders", fields: [customerId], references: [id])
  spaylaterTransactions SPayLaterTransaction[]

  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int      @map("order_id")
  productId   Int      @map("product_id")
  sellerId    Int      @map("seller_id")
  productName String   @map("product_name")
  price       Decimal  @db.Decimal(12, 2)
  quantity    Int
  subtotal    Decimal  @db.Decimal(12, 2)
  image       String?
  createdAt   DateTime @default(now()) @map("created_at")
  
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
  seller      User     @relation("SellerOrderItems", fields: [sellerId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([sellerId])
  @@map("order_items")
}

model SPayLaterCustomer {
  id              Int                    @id @default(autoincrement())
  userId          Int                    @unique @map("user_id")
  creditLimit     Decimal                @default(2000000) @map("credit_limit") @db.Decimal(12, 2)
  availableCredit Decimal                @default(2000000) @map("available_credit") @db.Decimal(12, 2)
  usedCredit      Decimal                @default(0) @map("used_credit") @db.Decimal(12, 2)
  totalPaid       Decimal                @default(0) @map("total_paid") @db.Decimal(12, 2)
  totalOverdue    Decimal                @default(0) @map("total_overdue") @db.Decimal(12, 2)
  isActive        Boolean                @default(true) @map("is_active")
  kycStatus       KYCStatus              @default(PENDING) @map("kyc_status")
  bankAccount     String?                @map("bank_account")
  bankName        String?                @map("bank_name")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")
  
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments        SPayLaterPayment[]
  transactions    SPayLaterTransaction[]

  @@index([userId])
  @@map("spaylater_customers")
}

model SPayLaterTransaction {
  id                 Int                @id @default(autoincrement())
  customerId         Int                @map("customer_id")
  orderId            Int?               @map("order_id")
  amount             Decimal            @db.Decimal(12, 2)
  paidAmount         Decimal            @default(0) @map("paid_amount") @db.Decimal(12, 2)
  purchaseDate       DateTime           @default(now()) @map("purchase_date")
  dueDate            DateTime           @map("due_date")
  status             SPayLaterStatus    @default(PENDING)
  lateFee            Decimal            @default(0) @map("late_fee") @db.Decimal(12, 2)
  metadata           Json?
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  
  payments           SPayLaterPayment[]
  customer           SPayLaterCustomer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order              Order?             @relation(fields: [orderId], references: [id])

  @@index([customerId])
  @@index([orderId])
  @@index([status])
  @@index([dueDate])
  @@map("spaylater_transactions")
}

model SPayLaterPayment {
  id                 Int                  @id @default(autoincrement())
  transactionId      Int                  @map("transaction_id")
  customerId         Int                  @map("customer_id")
  amount             Decimal              @db.Decimal(12, 2)
  paymentMethod      String               @map("payment_method")
  paymentDate        DateTime             @default(now()) @map("payment_date")
  status             PaymentStatus        @default(PENDING)
  metadata           Json?
  createdAt          DateTime             @default(now()) @map("created_at")
  
  customer           SPayLaterCustomer    @relation(fields: [customerId], references: [id])
  transaction        SPayLaterTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([customerId])
  @@index([paymentDate])
  @@map("spaylater_payments")
}

model Conversation {
  id                 Int      @id @default(autoincrement())
  user1Id            Int      @map("user1_id")
  user2Id            Int      @map("user2_id")
  lastMessage        String?  @map("last_message")
  lastMessageTime    DateTime? @map("last_message_time")
  unreadCountUser1   Int      @default(0) @map("unread_count_user1")
  unreadCountUser2   Int      @default(0) @map("unread_count_user2")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user1              User     @relation("ConversationUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2              User     @relation("ConversationUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  messages           Message[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@map("conversations")
}

model Message {
  id              Int      @id @default(autoincrement())
  conversationId  Int      @map("conversation_id")
  senderId        Int      @map("sender_id")
  receiverId      Int      @map("receiver_id")
  content         String
  messageType     String   @default("text") @map("message_type")
  productId       Int?     @map("product_id")
  isRead          Boolean  @default(false) @map("is_read")
  createdAt       DateTime @default(now()) @map("created_at")

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver        User         @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  product         Product?     @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("messages")
}

enum UserType {
  customer
  seller
}

enum OrderStatus {
  pending
  confirmed
  preparing
  shipping
  delivered
  cancelled
  returned
}

enum PaymentMethod {
  cod
  bank_transfer
  momo
  zalopay
  credit_card
  spaylater
}

enum SPayLaterStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Notification {
  id          Int      @id @default(autoincrement())
  userId      Int
  type        String   // order | system | promotion | review | message
  title       String
  message     String
  actionUrl   String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  @@map("notifications")
}
